<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Girá y Ganá en Bardol</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales y reseteo */
        body {
            font-family: "Inter", sans-serif;
            /* Fondo degradado más intenso y dinámico */
            background: linear-gradient(135deg, #a200ff 0%, #ff69b4 100%); /* Púrpura a Rosa vibrante */
            color: #ffffff; /* Texto blanco para el fondo oscuro */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
            /* Efecto de partículas de fondo */
            background-image: radial-gradient(circle at top left, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                              radial-gradient(circle at bottom right, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            background-size: 100% 100%;
            animation: background-pan 15s infinite alternate linear;
        }

        @keyframes background-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* Contenedor principal del juego */
        .game-container {
            max-width: 550px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95); /* Fondo blanco semi-transparente */
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); /* Sombra más pronunciada */
            overflow: hidden;
            margin: 20px 0;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(5px); /* Efecto de desenfoque para el fondo */
            -webkit-backdrop-filter: blur(5px);
            color: #4a2c5e; /* Restaurar color de texto para el contenedor */
        }

        /* Título animado de la landing */
        .animated-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #e91e63; /* Rosa vibrante */
            margin-bottom: 15px;
            animation: pulse-grow 2s infinite alternate;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2); /* Sombra de texto más fuerte */
        }

        @keyframes pulse-grow {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .subtitle {
            font-size: 1.1rem;
            color: #6a1b9a; /* Púrpura oscuro */
            margin-bottom: 25px;
        }

        .prize-counter {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00bcd4; /* Azul turquesa */
            margin-bottom: 25px;
        }

        /* Botones generales */
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            margin: 10px 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8a2be2 0%, #a200ff 100%); /* Púrpura a Púrpura más claro */
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); /* Verde a Verde oscuro */
            color: white;
        }

        /* Estilo específico para el botón de Mercado Pago */
        .btn-tertiary {
            background-color: #009EE3; /* Azul de Mercado Pago */
            color: white; /* Texto blanco */
        }

        .btn-tertiary:hover:not(:disabled) {
            background-color: #0083c2; /* Azul ligeramente más oscuro al pasar el ratón */
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .btn:active:not(:disabled) {
            transform: translateY(1px);
        }

        /* Contenedor de la ruleta */
        .roulette-canvas-container {
            position: relative;
            width: 100%; /* Ocupa todo el ancho disponible */
            /* Eliminado max-width para que no restrinja el tamaño en móviles */
            padding-bottom: 100%; /* Mantiene el aspecto cuadrado (1:1) */
            height: 0; /* Collapse height, padding-bottom defines it */
            margin: 30px auto;
            border: none; 
            box-shadow: none;
            border-radius: 50%; /* Asegura que el contenedor siga siendo circular */
            overflow: hidden; /* Importante para que el canvas se recorte en círculo */
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background-color: transparent; /* Fondo transparente para ver los segmentos */
            border-radius: 50%;
        }

        .wheel-indicator {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 40px solid #FFD700; /* Color dorado para el puntero */
            z-index: 10;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }

        /* Mensaje de resultado */
        #resultMessage {
            margin-top: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            color: #e91e63;
            animation: fadeIn 1s ease-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Confeti (simulado) */
        .confetti-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 20;
        }
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #ffd700; /* Color dorado */
            opacity: 0;
            animation: fall 3s ease-out forwards;
        }
        /* Variaciones para un efecto más dinámico */
        .confetti-piece:nth-child(2n) { background-color: #ff69b4; animation-delay: 0.2s; }
        .confetti-piece:nth-child(3n) { background-color: #7BEEB0; animation-delay: 0.4s; }
        .confetti-piece:nth-child(4n) { background-color: #a200ff; animation-delay: 0.6s; }

        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(500px) rotate(720deg); opacity: 0; }
        }

        /* Temporizador de premio */
        .prize-timer {
            font-size: 1.1rem;
            font-weight: bold;
            color: #007bb6;
            margin-top: 10px;
        }

        /* Enlace Mercado Pago */
        .mercadopago-link-container {
            margin-top: 20px;
            font-size: 1rem;
            color: #4a2c5e;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .mercadopago-link-container a {
            color: #007bb6;
            font-weight: bold;
            text-decoration: underline;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Upselling Section */
        .upselling-section {
            background: #e6e6fa;
            color: #4a2c5e;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
            border: 2px dashed #9370db;
            display: none; /* Oculto por defecto */
        }
        .upselling-section h3 {
            font-size: 1.4rem;
            color: #6a1b9a;
            margin-bottom: 15px;
        }
        .upselling-section p {
            font-size: 1rem;
            margin-bottom: 15px;
        }

        /* WhatsApp Input Modal */
        .whatsapp-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .whatsapp-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .whatsapp-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        .whatsapp-modal-content h3 {
            font-size: 1.5rem;
            color: #e91e63;
            margin-bottom: 20px;
        }
        .whatsapp-modal-content input {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #e0c8f0;
            border-radius: 10px;
            font-size: 1rem;
        }
        .whatsapp-modal-content .btn {
            margin-top: 0;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8a2be2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Alert Styles */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than other modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-alert-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .custom-alert-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .custom-alert-content p {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a2c5e;
            margin-bottom: 20px;
        }
        .custom-alert-content button {
            background: linear-gradient(135deg, #8a2be2 0%, #a200ff 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .custom-alert-content button:hover {
            background: linear-gradient(135deg, #a200ff 0%, #8a2be2 100%);
        }


        /* Responsive adjustments */
        @media (max-width: 480px) {
            .animated-title {
                font-size: 1.8rem;
            }
            .subtitle {
                font-size: 1rem;
            }
            .prize-counter {
                font-size: 1rem;
            }
            .btn {
                font-size: 1rem;
                padding: 12px;
            }
            #resultMessage {
                font-size: 1.4rem;
            }
            .roulette-canvas-container {
                width: 95vw; /* Ocupa el 95% del ancho del viewport */
                margin: 20px auto; /* Centrar después de ajustar el ancho */
            }
        }
    </style>
</head>
<body>
    <div class="game-container" id="landingScreen">
        <h1 class="animated-title">🎉 ¡GIRÁ LA RULETA MÁGICA DE BARDOL Y GANÁ! 🎁</h1>
        <p class="subtitle">Podés ganar zonas GRATIS o un 30% OFF en tu siguiente zona.</p>
        <p class="prize-counter" id="prizesLeftDisplay">🎁 Solo quedan 1000 premios disponibles.</p>
        <button id="startRouletteBtn" class="btn btn-primary">👉 GIRAR LA RULETA AHORA</button>
    </div>

    <div class="game-container" id="rouletteScreen" style="display: none;">
        <h1 class="animated-title">¡Mucha Suerte!</h1>
        <p class="subtitle">Gira la ruleta y descubre tu premio.</p>
        <div class="roulette-canvas-container">
            <canvas id="rouletteCanvas"></canvas>
            <!-- El logo central ha sido eliminado -->
            <div class="wheel-indicator"></div>
        </div>
        <button id="spinBtn" class="btn btn-secondary">
            <i class="fas fa-play-circle"></i> Girar Ruleta
        </button>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <p id="resultMessage" class="mt-4"></p>

        <div id="postSpinActions" class="mt-8" style="display: none;">
            <p class="prize-timer" id="prizeTimerDisplay"></p>
            <div class="mercadopago-link-container" id="mercadopagoLinkContainer" style="display: none;">
                <p>Para reservar tu premio, abona una seña de <span id="mercadopagoPriceDisplay"></span> aquí:</p>
                <a href="#" id="mercadopagoLink" target="_blank" class="btn btn-tertiary flex items-center justify-center">
                    <img src="https://placehold.co/24x24/ffffff/000000?text=MP" alt="Mercado Pago Logo" class="mr-2"> 
                    Reservar y Pagar Seña
                </a>
                <button class="btn btn-secondary mt-2" id="markSeñaPaidBtn">
                    Marcar Seña como Pagada (Demo)
                </button>
            </div>
            <button id="usePrizeBtn" class="btn btn-primary mt-4" style="display: none;">
                <i class="fas fa-gift"></i> Usar mi Premio
            </button>
            <button id="shareAndSpinBtn" class="btn btn-tertiary mt-4">
                <i class="fas fa-share-alt"></i> Compartí y ganá otra tirada
            </button>
        </div>

        <div id="upsellingSection" class="upselling-section" style="display: none;">
            <h3>¿Querés sumar otra zona con 30% OFF?</h3>
            <p>Aprovecha esta oportunidad única para complementar tu premio.</p>
            <a href="#" id="upsellingLink" target="_blank" class="btn btn-secondary">
                <i class="fas fa-tag"></i> Ver zonas disponibles y reservar con descuento
            </a>
        </div>
    </div>

    <!-- WhatsApp Input Modal -->
    <div id="whatsappModalOverlay" class="whatsapp-modal-overlay">
        <div class="whatsapp-modal-content">
            <h3>¡Ganaste un Cupón Sorpresa!</h3>
            <p>Para enviarte tu cupón, por favor, déjanos tu número de WhatsApp.</p>
            <input type="text" id="whatsappInput" placeholder="Ej: +5493411234567">
            <button id="sendWhatsappBtn" class="btn btn-primary">Enviar Cupón por WhatsApp</button>
        </div>
    </div>

    <!-- Custom Alert Overlay -->
    <div id="customAlertOverlay" class="custom-alert-overlay">
        <div class="custom-alert-content">
            <p id="customAlertMessage"></p>
            <button id="customAlertCloseBtn">Aceptar</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN DEL JUEGO ---
        const MERCADOPAGO_LINK_URL = 'https://mpago.la/tu-link-de-mercado-pago-aqui'; // ¡IMPORTANTE: REEMPLAZA ESTO!
        const MERCADOPAGO_PRICE = '$5000'; // Precio de la seña

        const PRIZE_RESERVATION_DURATION_MS = 30 * 60 * 1000; // 30 minutos
        const INITIAL_PRIZES_AVAILABLE = 1000; // Número inicial de premios disponibles (simulado)

        // Definición de los segmentos de la ruleta
        const segments = [
            { text: 'Axilas GRATIS', type: 'free_zone', value: 'Axilas', description: 'Axilas GRATIS', needsSeña: true },
            { text: 'Media Pierna GRATIS', type: 'free_zone', value: 'Media Pierna', description: 'Media Pierna GRATIS', needsSeña: true },
            { text: '30% OFF Cualquier Zona', type: 'discount', value: 30, description: '30% OFF en cualquier zona', needsSeña: true },
            { text: 'Zona Pequeña GRATIS', type: 'free_zone', value: 'Zona Pequeña', description: 'Zona pequeña a elección (bozo, mentón, línea alba, manos)', needsSeña: true },
            { text: '2x1 en Sesión', type: '2x1', value: 'Sesión', description: '2x1 en sesión', needsSeña: true },
            { text: 'Cupón Sorpresa!', type: 'surprise_coupon', description: '¡Ganaste un cupón sorpresa!', needsSeña: false },
            { text: '10% OFF Asegurado', type: 'discount', value: 10, description: '10% OFF asegurado', needsSeña: false }
        ];

        // Paleta de colores inspirada en el logo y los ejemplos, más vibrante
        const segmentColors = ['#FF6B6B', '#7BEEB0', '#a200ff', '#FF9AA2', '#00bcd4', '#FFD700', '#D8BFD8']; 
        const numSegments = segments.length;
        const arc = (2 * Math.PI) / numSegments; // Ángulo de cada segmento en radianes

        // --- ELEMENTOS DEL DOM ---
        const landingScreen = document.getElementById('landingScreen');
        const rouletteScreen = document.getElementById('rouletteScreen');
        const startRouletteBtn = document.getElementById('startRouletteBtn');
        const rouletteCanvas = document.getElementById('rouletteCanvas');
        const ctx = rouletteCanvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultMessage = document.getElementById('resultMessage');
        const postSpinActions = document.getElementById('postSpinActions');
        const prizeTimerDisplay = document.getElementById('prizeTimerDisplay');
        const mercadopagoLinkContainer = document.getElementById('mercadopagoLinkContainer');
        const mercadopagoLink = document.getElementById('mercadopagoLink');
        const mercadopagoPriceDisplay = document.getElementById('mercadopagoPriceDisplay');
        const markSeñaPaidBtn = document.getElementById('markSeñaPaidBtn');
        const usePrizeBtn = document.getElementById('usePrizeBtn');
        const shareAndSpinBtn = document.getElementById('shareAndSpinBtn');
        const upsellingSection = document.getElementById('upsellingSection');
        const upsellingLink = document.getElementById('upsellingLink');
        const whatsappModalOverlay = document.getElementById('whatsappModalOverlay');
        const whatsappInput = document.getElementById('whatsappInput');
        const sendWhatsappBtn = document.getElementById('sendWhatsappBtn');
        const prizesLeftDisplay = document.getElementById('prizesLeftDisplay');
        const customAlertOverlay = document.getElementById('customAlertOverlay');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        // --- ESTADO DEL JUEGO ---
        let currentRotation = 0;
        let wonPrize = null;
        let prizeEndTime = 0;
        let prizeSeñaPaid = false;
        let prizesAvailable = INITIAL_PRIZES_AVAILABLE;
        let prizeTimerInterval;

        // --- FUNCIONES DE ALMACENAMIENTO (LOCALSTORAGE) ---
        function saveGameState() {
            localStorage.setItem('wonPrize', JSON.stringify(wonPrize));
            localStorage.setItem('prizeEndTime', prizeEndTime);
            localStorage.setItem('prizeSeñaPaid', prizeSeñaPaid);
            localStorage.setItem('prizesAvailable', prizesAvailable);
        }

        function loadGameState() {
            const savedWonPrize = localStorage.getItem('wonPrize');
            const savedPrizeEndTime = localStorage.getItem('prizeEndTime');
            const savedPrizeSeñaPaid = localStorage.getItem('prizeSeñaPaid');
            const savedPrizesAvailable = localStorage.getItem('prizesAvailable');

            if (savedWonPrize && savedWonPrize !== 'null') wonPrize = JSON.parse(savedWonPrize);
            if (savedPrizeEndTime) prizeEndTime = parseInt(savedPrizeEndTime, 10);
            if (savedPrizeSeñaPaid) prizeSeñaPaid = (savedPrizeSeñaPaid === 'true');
            if (savedPrizesAvailable) prizesAvailable = parseInt(savedPrizesAvailable, 10);
        }

        function resetGameState() {
            wonPrize = null;
            prizeEndTime = 0;
            prizeSeñaPaid = false;
            // prizesAvailable se mantiene o se reinicia según la lógica de campaña
            if (prizeTimerInterval) clearInterval(prizeTimerInterval);
            saveGameState();
            updateUI(); // Llamar a updateUI para reflejar el estado reseteado
        }

        // --- FUNCIONES DE DIBUJO DE LA RULETA ---
        function resizeCanvas() {
            const container = document.querySelector('.roulette-canvas-container');
            const containerWidth = container.offsetWidth; // Usar offsetWidth para obtener el ancho calculado
            rouletteCanvas.width = containerWidth;
            rouletteCanvas.height = containerWidth;
            drawRoulette(currentRotation);
        }

        function drawRoulette(rotation = 0) {
            ctx.clearRect(0, 0, rouletteCanvas.width, rouletteCanvas.height);
            const centerX = rouletteCanvas.width / 2;
            const centerY = rouletteCanvas.height / 2;
            // Asegurarse de que el radio sea siempre positivo, con un mínimo de 10px
            const radius = Math.max(10, Math.min(centerX, centerY) - 20); 

            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(rotation);

            for (let i = 0; i < numSegments; i++) {
                const angle = i * arc;
                const color = segmentColors[i % segmentColors.length];

                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + arc);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#4a2c5e';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Dibujar texto del segmento
                ctx.save();
                ctx.rotate(angle + arc / 2);
                ctx.fillStyle = '#FFFFFF'; // Letra blanca
                
                // Ajuste del tamaño de la fuente para que quepa mejor
                // Se ha ajustado el multiplicador y los límites para una mejor visibilidad
                const minFontSize = 16; // Aumentado para mayor legibilidad en móviles
                const maxFontSize = 24; // Ajustado para evitar desbordamiento en pantallas grandes
                const calculatedFontSize = radius * 0.09; // Multiplicador ajustado para achicar la letra
                const fontSize = Math.max(minFontSize, Math.min(maxFontSize, calculatedFontSize));
                
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Añadir sombra negra al texto para mejor contraste
                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)'; // Sombra negra más opaca
                ctx.shadowBlur = 3;
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;

                // Posicionar el texto a una distancia del centro.
                // Ajustar el multiplicador (0.55) para mover el texto más hacia el borde o el centro
                ctx.fillText(segments[i].text, radius * 0.55, 0); 
                ctx.restore();
            }
            ctx.restore();
        }

        let animationFrameId;
        function animateRoulette(finalAngle, duration) {
            const startAngle = currentRotation;
            const startTime = performance.now();

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = 1 - Math.pow(1 - progress, 3);

                currentRotation = startAngle + (finalAngle - startAngle) * easedProgress;
                drawRoulette(currentRotation);

                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animate);
                } else {
                    currentRotation = finalAngle % (2 * Math.PI);
                    drawRoulette(currentRotation);
                    handleSpinEnd();
                }
            }
            animationFrameId = requestAnimationFrame(animate);
        }

        // --- LÓGICA DEL JUEGO ---
        function spinRoulette() {
            spinBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            resultMessage.textContent = '';
            postSpinActions.style.display = 'none'; // Ocultar antes del giro
            upsellingSection.style.display = 'none'; // Ocultar antes del giro

            const randomSegmentIndex = Math.floor(Math.random() * numSegments);
            const winningPrize = segments[randomSegmentIndex];

            // Calcular el ángulo para que el puntero apunte al centro del segmento ganador
            // El puntero está en la parte superior (1.5 * PI o 270 grados).
            // El centro del segmento `randomSegmentIndex` está en `(randomSegmentIndex * arc + arc / 2)`.
            // Queremos que `(randomSegmentIndex * arc + arc / 2)` se alinee con `1.5 * PI`.
            // La rotación necesaria es `(1.5 * Math.PI - (randomSegmentIndex * arc + arc / 2))`.
            let targetAngleRelativeToZero = (1.5 * Math.PI - (randomSegmentIndex * arc + arc / 2));
            targetAngleRelativeToZero = (targetAngleRelativeToZero % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);

            const extraRotations = 5; // Mínimo 5 vueltas completas
            let angleToReach = targetAngleRelativeToZero - (currentRotation % (2 * Math.PI));
            if (angleToReach < 0) {
                angleToReach += (2 * Math.PI);
            }
            const absoluteFinalAngle = currentRotation + angleToReach + (extraRotations * 2 * Math.PI);

            animateRoulette(absoluteFinalAngle, 6000); // 6 segundos de duración

            // Guardar el premio ganado inmediatamente (aunque no se haya "activado")
            wonPrize = winningPrize;
            saveGameState();
        }

        function handleSpinEnd() {
            loadingSpinner.style.display = 'none';
            spinBtn.disabled = false;
            resultMessage.textContent = `🎉 ¡FELICITACIONES! GANASTE: ${wonPrize.description}`;
            resultMessage.style.color = '#e91e63';
            
            // Simular efecto de confeti
            triggerConfetti();

            postSpinActions.style.display = 'block'; // Mostrar después del giro
            upsellingSection.style.display = 'block'; // Mostrar después del giro

            // Reiniciar visibilidad de los botones de MP y Usar Premio para evitar estados incorrectos
            mercadopagoLinkContainer.style.display = 'none';
            markSeñaPaidBtn.style.display = 'none';
            usePrizeBtn.style.display = 'none';
            prizeTimerDisplay.style.display = 'none';

            if (wonPrize.needsSeña) {
                mercadopagoPriceDisplay.textContent = MERCADOPAGO_PRICE;
                mercadopagoLink.href = MERCADOPAGO_LINK_URL;
                
                const now = Date.now();
                // Si el premio ya estaba activo y el tiempo no ha expirado, o si la seña ya fue pagada
                if (prizeSeñaPaid || (wonPrize && now < prizeEndTime)) {
                    mercadopagoLinkContainer.style.display = 'flex'; // Mostrar enlace de MP
                    markSeñaPaidBtn.style.display = 'block'; // Mostrar botón de demo
                    if (!prizeSeñaPaid) { // Si no está pagada, iniciar/continuar temporizador
                        startPrizeTimer();
                        usePrizeBtn.style.display = 'none';
                    } else { // Si ya está pagada, ocultar temporizador y mostrar botón de usar
                        prizeTimerDisplay.style.display = 'none';
                        mercadopagoLinkContainer.style.display = 'none'; // Ocultar MP si ya se pagó la seña
                        markSeñaPaidBtn.style.display = 'none';
                        usePrizeBtn.style.display = 'block';
                        usePrizeBtn.disabled = false;
                    }
                } else { // El tiempo expiró y la seña no fue pagada, o es un premio nuevo que necesita seña
                    prizeEndTime = Date.now() + PRIZE_RESERVATION_DURATION_MS; // Establecer nuevo tiempo de expiración
                    startPrizeTimer(); // Iniciar el temporizador
                    mercadopagoLinkContainer.style.display = 'flex'; // Mostrar enlace de MP
                    markSeñaPaidBtn.style.display = 'block'; // Mostrar botón de demo
                    usePrizeBtn.style.display = 'none'; // Ocultar hasta que se pague la seña
                }
            } else { // El premio no necesita seña
                usePrizeBtn.style.display = 'block';
                usePrizeBtn.disabled = false;
                if (wonPrize.type === 'surprise_coupon') {
                    showWhatsappModal(); // Mostrar modal de WhatsApp para cupón sorpresa
                }
            }
            updatePrizesAvailableDisplay();
            saveGameState(); // Guardar el estado después de todas las actualizaciones de UI
        }

        function startPrizeTimer() {
            if (prizeTimerInterval) clearInterval(prizeTimerInterval);

            prizeTimerDisplay.style.display = 'block';
            prizeTimerInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = prizeEndTime - now;

                if (timeLeft <= 0) {
                    clearInterval(prizeTimerInterval);
                    prizeTimerDisplay.textContent = '⏳ Tiempo para reservar expirado. ¡El premio se ha liberado!';
                    prizeTimerDisplay.style.color = '#e53e3e';
                    // Resetear el premio si el tiempo expira y no se pagó la seña
                    if (!prizeSeñaPaid) {
                        resetGameState(); // Limpia el premio y lo hace disponible para otros
                        resultMessage.textContent = '¡El premio se ha liberado a otro usuario!';
                        resultMessage.style.color = '#e53e3e';
                        postSpinActions.style.display = 'none';
                        upsellingSection.style.display = 'none';
                        spinBtn.disabled = false; // Habilita para un nuevo giro si es posible
                    }
                    return;
                }

                const minutes = Math.floor(timeLeft / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                prizeTimerDisplay.textContent = `⏳ Tenés ${minutes}m ${seconds}s para reservar tu turno.`;
                prizeTimerDisplay.style.color = '#007bb6';
            }, 1000);
        }

        function triggerConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.classList.add('confetti-effect');
            rouletteScreen.appendChild(confettiContainer);

            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.classList.add('confetti-piece');
                piece.style.left = Math.random() * 100 + '%';
                piece.style.top = Math.random() * 100 + '%';
                piece.style.backgroundColor = segmentColors[Math.floor(Math.random() * segmentColors.length)];
                piece.style.animationDelay = (Math.random() * 2) + 's';
                piece.style.transform = `scale(${Math.random() * 0.8 + 0.2})`; // Tamaño aleatorio
                confettiContainer.appendChild(piece);
            }

            // Eliminar el confeti después de un tiempo
            setTimeout(() => {
                confettiContainer.remove();
            }, 3000);
        }

        function updatePrizesAvailableDisplay() {
            prizesLeftDisplay.textContent = `🎁 Solo quedan ${prizesAvailable} premios disponibles.` + (prizesAvailable > 0 ? '' : ' ¡Agotados!');
            if (prizesAvailable <= 50 && prizesAvailable > 0) { // Resaltar si quedan pocos
                prizesLeftDisplay.classList.add('text-red-500', 'font-bold');
            } else {
                prizesLeftDisplay.classList.remove('text-red-500', 'font-bold');
            }
        }

        function showWhatsappModal() {
            whatsappModalOverlay.classList.add('show');
        }

        function hideWhatsappModal() {
            whatsappModalOverlay.classList.remove('show');
        }

        // Custom Alert Functions
        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlertOverlay.classList.add('show');
        }

        customAlertCloseBtn.addEventListener('click', () => {
            customAlertOverlay.classList.remove('show');
        });

        // --- EVENT LISTENERS ---
        startRouletteBtn.addEventListener('click', () => {
            landingScreen.style.display = 'none';
            rouletteScreen.style.display = 'block';
            resizeCanvas(); // Ajustar el tamaño del canvas al mostrar la ruleta
            // No se inicia el giro automáticamente aquí, el usuario debe hacer clic en "Girar Ruleta"
        });

        spinBtn.addEventListener('click', () => {
            // Asumiendo que rouletteSpinsLeft es una variable global o de alcance superior
            // Si la ruleta está en el mismo archivo que el código principal, esta variable
            // puede ser la misma que `spinsLeft` del otro script, o una nueva.
            // Por el contexto, parece que esta ruleta es una sección separada,
            // así que usaremos `rouletteSpinsLeft` como su contador interno.
            if (rouletteSpinsLeft > 0) {
                loadingSpinner.style.display = 'block';
                spinBtn.disabled = true;
                rouletteSpinsLeft--; // Decrementar el giro al inicio
                saveGameState(); // Guardar el estado de los giros
                updateUI(); // Actualizar la UI inmediatamente
                
                const randomSegmentIndex = Math.floor(Math.random() * numSegments);
                
                let targetAngleRelativeToZero = (1.5 * Math.PI - (randomSegmentIndex * arc + arc / 2));
                targetAngleRelativeToZero = (targetAngleRelativeToZero % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);

                const extraRotations = 5; // Minimum 5 full spins for visual effect
                let angleToReach = targetAngleRelativeToZero - (currentRotation % (2 * Math.PI));
                if (angleToReach < 0) {
                    angleToReach += (2 * Math.PI); // Ensure it spins forward to the target
                }
                const absoluteFinalAngle = currentRotation + angleToReach + (extraRotations * 2 * Math.PI);

                animateRoulette(absoluteFinalAngle, 6000); // 6 seconds duration
            } else {
                updateUI(); // Asegurarse de que el mensaje de bloqueo se muestre
            }
        });


        markSeñaPaidBtn.addEventListener('click', () => {
            prizeSeñaPaid = true;
            // No se decrementa prizesAvailable aquí, solo cuando se "usa" el premio o se "reserva" realmente
            if (prizeTimerInterval) clearInterval(prizeTimerInterval);
            saveGameState();
            updatePrizesAvailableDisplay(); // Solo para actualizar el texto si es necesario
            updateUI(); // Actualizar la UI para mostrar el botón "Usar Premio"
            showCustomAlert('¡Seña marcada como pagada! Ahora puedes usar tu premio.'); // Notificación simple
        });

        usePrizeBtn.addEventListener('click', () => {
            if (wonPrize) {
                let message = `¡Hola Le Bardol! Quiero usar mi premio de ruleta: ${wonPrize.description}.`;
                if (wonPrize.needsSeña && prizeSeñaPaid) {
                    message += ` Ya aboné la seña de ${MERCADOPAGO_PRICE}.`;
                }
                const whatsappUrl = `https://wa.me/5493415216025?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                showCustomAlert(`¡Has usado tu premio: ${wonPrize.description}! Te hemos redirigido a WhatsApp para coordinar.`);
                resetGameState(); // Limpiar el estado del premio después de usarlo
                spinBtn.disabled = false; // Habilitar para un nuevo giro
            }
        });

        shareAndSpinBtn.addEventListener('click', () => {
            const shareMessage = encodeURIComponent("¡Acabo de girar la ruleta de Bardol y gané un premio increíble! ¡Vos también podés ganar! Entrá aquí: [TU_LINK_A_ESTA_PAGINA]");
            const whatsappShareUrl = `https://wa.me/?text=${shareMessage}`;
            window.open(whatsappShareUrl, '_blank');
            
            // Simular que se ganó un giro adicional al compartir
            showCustomAlert('¡Gracias por compartir! Has ganado un giro adicional.');
            // Para este demo, simplemente permitimos otro giro. En un sistema real,
            // se debería verificar si realmente se compartió antes de dar el giro.
            spinBtn.disabled = false; 
            resultMessage.textContent = '¡Tienes un giro extra por compartir!';
            postSpinActions.style.display = 'none'; // Ocultar acciones post-giro para el nuevo giro
            upsellingSection.style.display = 'none';
        });

        sendWhatsappBtn.addEventListener('click', () => {
            const whatsappNumber = whatsappInput.value.trim();
            if (whatsappNumber) {
                let message = `¡Hola Le Bardol! Soy un/a ganador/a de la ruleta. Mi número de WhatsApp es ${whatsappNumber}. Gané: ${wonPrize.description}. ¡Espero mi cupón sorpresa!`;
                const whatsappUrl = `https://wa.me/5493415216025?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                showCustomAlert('¡Gracias! Te contactaremos por WhatsApp con tu cupón sorpresa.');
                hideWhatsappModal();
                resetGameState(); // Limpiar el estado del premio después de "enviarlo"
                spinBtn.disabled = false;
            } else {
                showCustomAlert('Por favor, ingresa tu número de WhatsApp.');
            }
        });

        // Cierra el modal si se hace clic fuera del contenido
        whatsappModalOverlay.addEventListener('click', (e) => {
            if (e.target === whatsappModalOverlay) {
                hideWhatsappModal();
            }
        });

        // --- FUNCIÓN DE ACTUALIZACIÓN DE UI GENERAL ---
        // Esta función se llama al cargar y después de cambios de estado importantes
        function updateUI() {
            // Lógica para mostrar/ocultar elementos basada en el estado actual
            const now = Date.now();

            // Mostrar/ocultar postSpinActions y upsellingSection
            if (wonPrize && (wonPrize.needsSeña ? (now < prizeEndTime || prizeSeñaPaid) : true)) {
                postSpinActions.style.display = 'block';
                upsellingSection.style.display = 'block';
                spinBtn.disabled = true; // Deshabilitar el botón de girar si ya hay un premio activo
            } else {
                postSpinActions.style.display = 'none';
                upsellingSection.style.display = 'none';
                spinBtn.disabled = false; // Habilitar el botón de girar si no hay premio activo
            }

            // Lógica específica para Mercado Pago y botón "Usar Premio"
            mercadopagoLinkContainer.style.display = 'none';
            markSeñaPaidBtn.style.display = 'none';
            usePrizeBtn.style.display = 'none';
            prizeTimerDisplay.style.display = 'none';

            if (wonPrize) {
                if (wonPrize.needsSeña) {
                    mercadopagoPriceDisplay.textContent = MERCADOPAGO_PRICE;
                    mercadopagoLink.href = MERCADOPAGO_LINK_URL;
                    
                    if (!prizeSeñaPaid && now < prizeEndTime) {
                        mercadopagoLinkContainer.style.display = 'flex';
                        markSeñaPaidBtn.style.display = 'block';
                        startPrizeTimer(); // Asegura que el temporizador esté corriendo
                    } else if (prizeSeñaPaid) {
                        usePrizeBtn.style.display = 'block';
                        usePrizeBtn.disabled = false;
                        mercadopagoLinkContainer.style.display = 'none'; // Ocultar MP si ya se pagó la seña
                        markSeñaPaidBtn.style.display = 'none';
                    } else { // Premio expirado o seña no pagada a tiempo
                        resultMessage.textContent = '¡El premio se ha liberado a otro usuario!';
                        resultMessage.style.color = '#e53e3e';
                        wonPrize = null; // Limpiar el premio
                        saveGameState();
                        resetGameState(); // Vuelve a llamar a updateUI para limpiar la pantalla
                        return; // Salir para evitar más procesamiento
                    }
                } else { // Premio no necesita seña
                    usePrizeBtn.style.display = 'block';
                    usePrizeBtn.disabled = false;
                }
                resultMessage.textContent = `🎉 ¡FELICITACIONES! GANASTE: ${wonPrize.description}`;
                resultMessage.style.color = '#e91e63';
            } else {
                resultMessage.textContent = ''; // Limpiar mensaje si no hay premio
            }

            updatePrizesAvailableDisplay();
            saveGameState();
        }


        // --- INICIALIZACIÓN ---
        window.onload = function() {
            loadGameState();
            updatePrizesAvailableDisplay();
            resizeCanvas(); // Ajustar el tamaño del canvas al cargar
            window.addEventListener('resize', resizeCanvas); // Ajustar el tamaño del canvas al redimensionar
            
            // Lógica para mostrar la pantalla inicial o la ruleta si ya hay un premio activo
            const now = Date.now();
            if (wonPrize && (wonPrize.needsSeña ? (now < prizeEndTime || prizeSeñaPaid) : true)) {
                landingScreen.style.display = 'none';
                rouletteScreen.style.display = 'block';
                updateUI(); // Asegurarse de que la UI refleje el premio existente
            } else {
                landingScreen.style.display = 'block';
                rouletteScreen.style.display = 'none';
                resetGameState(); // Asegurarse de que el estado esté limpio si no hay premio activo
            }
        };
    </script>
</body>
</html>
