<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Bardol Est√©tica Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos generales y reseteo */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f9f0ff 0%, #fff0f5 100%); /* Fondo degradado suave */
            color: #4a2c5e; /* Color de texto principal */
            min-height: 100vh; /* Altura m√≠nima para ocupar toda la pantalla */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px; /* Espaciado alrededor del cuerpo */
            overflow-x: hidden; /* Evita el scroll horizontal */
        }
        
        /* Contenedor principal de la tarjeta */
        .container {
            max-width: 500px; /* Ancho m√°ximo */
            width: 100%; /* Ocupa el 100% del ancho disponible hasta el max-width */
            background: white; /* Fondo blanco */
            border-radius: 20px; /* Bordes redondeados */
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.15); /* Sombra suave */
            overflow: hidden; /* Oculta contenido que se desborda */
            margin: 20px 0; /* Margen superior e inferior */
            position: relative;
        }
        
        /* Secci√≥n del encabezado */
        .header {
            background: linear-gradient(135deg, #FFC0CB 0%, #FFB6C1 100%); /* Fondo rosa pastel con degradado */
            color: white; /* Texto blanco */
            padding: 30px 20px; /* Espaciado interno */
            text-align: center; /* Centra el contenido */
            position: relative;
        }
        
        /* Estilos para el logo */
        .header-logo { 
            display: block; 
            margin: 0 auto 15px; 
            max-width: 393px; /* Establece el max-width para el tama√±o original deseado */
            width: 100%; /* Asegura que la imagen sea responsiva */
            height: auto; /* Mantiene la proporci√≥n de la imagen */
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        /* Tarjeta de oferta */
        .offer-card {
            background: #fff9c4; /* Fondo amarillo claro */
            color: #5d4037; /* Color de texto oscuro */
            border-radius: 15px; /* Bordes redondeados */
            padding: 15px; /* Espaciado interno */
            margin: 20px; /* Margen externo */
            text-align: center; /* Centra el contenido */
            border: 2px dashed #ffd54f; /* Borde punteado */
            position: relative;
        }
        
        .offer-card h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #e91e63; /* Color de t√≠tulo de oferta */
        }
        
        .offer-card p {
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        /* Contador regresivo */
        .countdown {
            display: flex;
            justify-content: center;
            gap: 10px; /* Espacio entre los elementos del contador */
            margin: 15px 0;
        }
        
        .countdown-box {
            background: #4a2c5e; /* Fondo oscuro */
            color: white; /* Texto blanco */
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .countdown-value {
            font-size: 22px;
        }
        
        .countdown-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.8;
        }
        
        /* Contenedor del formulario */
        .form-container {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px; /* Espacio entre grupos de formulario */
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a2c5e;
        }
        
        /* Estilos para input de texto */
        input[type="text"] {
            width: 100%; /* Ocupa todo el ancho disponible */
            padding: 14px; /* Espaciado interno */
            border: 2px solid #e0c8f0;
            border-radius: 12px;
            font-size: 16px;
            background: #f9f0ff;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #8a2be2;
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
        }

        /* Estilo para mostrar la fecha de turno (que ahora se rellenar√° por JS) */
        #displayDate {
            background: #e0f2f7;
            padding: 14px;
            border: 2px solid #a7d9f7;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            color: #007bb6;
            display: block;
            text-align: center;
        }
        
        /* Estilos de botones */
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            margin: 10px 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn-confirm {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
        }
        
        .btn-invite {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(1px);
        }
        
        /* Notificaci√≥n emergente */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(110%);
            transition: transform 0.4s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Icono flotante de WhatsApp */
        .whatsapp-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #25d366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Pie de p√°gina */
        .footer {
            text-align: center;
            padding: 20px;
            color: #7b68ee;
            font-size: 14px;
            margin-top: 20px;
        }
        
        /* Disclaimer o aviso */
        .disclaimer {
            background: #e0f7fa;
            border-left: 44px solid #00bcd4;
            padding: 10px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        /* Nueva tarjeta de referido para difusi√≥n */
        .referral-promo-diffusion {
            background: #e0f7fa;
            color: #00796b;
            border-radius: 15px;
            padding: 15px;
            margin: 20px;
            text-align: center;
            border: 2px dashed #00bcd4;
        }

        .referral-promo-diffusion h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #00bcd4;
        }

        .referral-promo-diffusion p {
            font-size: 15px;
            margin-bottom: 15px;
        }

        /* Estilos para la Ruleta */
        .roulette-section {
            padding: 20px;
            background: #fdfdfd;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            text-align: center;
            display: none; /* Oculto por defecto, se muestra con JS */
        }

        .roulette-section h1 {
            color: #e91e63;
            font-size: 26px;
            margin-bottom: 20px;
        }

        .roulette-section .referral-offer-text {
            font-size: 16px;
            color: #4a2c5e;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .roulette-section .spin-count-display {
            font-size: 18px;
            font-weight: bold;
            color: #8a2be2;
            margin-bottom: 15px;
        }

        /* Contenedor de la ruleta para control de tama√±o */
        .roulette-canvas-container {
            position: relative;
            width: 100%;
            max-width: 500px; /* Max size for the roulette area */
            padding-bottom: 100%; /* Maintain aspect ratio (1:1 square) */
            height: 0; /* Collapse height, padding-bottom defines it */
            margin: 20px auto;
            border: 5px solid #FFC0CB; /* Border for the whole wheel area */
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.3);
            overflow: hidden; /* Ensure content stays within circle */
        }

        canvas {
            position: absolute; /* Position canvas within its responsive container */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background-color: #eee;
            border-radius: 50%; /* Ensure it stays circular */
        }

        .wheel-indicator {
            position: absolute;
            top: -20px; /* Posiciona el puntero ligeramente por encima de la ruleta */
            left: 50%;
            transform: translateX(-50%); /* Centra horizontalmente */
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid #e91e63; /* Color de la flecha */
            z-index: 10;
        }

        .buttons-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn-spin {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); /* Verde */
            color: white;
        }

        .btn-use-discount {
            background: linear-gradient(135deg, #8a2be2 0%, #6a1b9a 100%); /* Morado */
            color: white;
            display: none; /* Oculto por defecto */
        }

        #resultMessage {
            margin-top: 20px;
            font-size: 22px;
            font-weight: bold;
            color: #e91e63;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8a2be2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none; /* Oculto por defecto */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .prize-timer {
            font-size: 18px;
            font-weight: bold;
            color: #007bb6;
            margin-top: 10px;
            display: none; /* Oculto por defecto */
        }

        .mercadopago-link-container {
            margin-top: 15px;
            font-size: 15px;
            color: #4a2c5e;
        }

        .mercadopago-link-container a {
            color: #007bb6;
            font-weight: bold;
            text-decoration: underline;
        }

        /* Estilos para la Lista de Precios */
        .price-list-section {
            padding: 20px;
            background: #fdfdfd;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin: 20px; /* Margen para separarlo de otros elementos */
            text-align: center;
            display: none; /* Oculto por defecto */
        }

        .price-list-section h2 {
            color: #4a2c5e;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .price-list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .price-list-table th, .price-list-table td {
            padding: 12px 15px;
            border: 1px solid #e0c8f0;
            text-align: left;
            font-size: 16px;
        }

        .price-list-table th {
            background-color: #f0e6fa;
            color: #6a1b9a;
            font-weight: bold;
            text-transform: uppercase;
        }

        .price-list-table tr:nth-child(even) {
            background-color: #f9f0ff;
        }

        .price-list-table td:last-child {
            text-align: right;
            font-weight: bold;
            color: #e91e63;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <address>
                    <img src="logo lb.png" alt="le bardol " title="le bardol logo " class="header-logo">
                </address>
                <br>
            </div>
            <h1 id="mainTitle">Le Bardol Est√©tica Center</h1>
            <p class="subtitle">Tu belleza, nuestra pasi√≥n</p>
        </div>
        <div class="offer-card" id="mainOfferCard">
            <h2 id="offerTitle">¬°Oferta Especial de Referidos!</h2>
            <p id="offerDescription">Confirma tu turno y si invitas a tus amigos en las pr√≥ximas 24
                horas, t√∫ obtienes un <strong>10% DE DESCUENTO</strong> por cada
                uno que contrate un servicio, ¬°y ellos un <strong>50% DE
                DESCUENTO</strong> en su primer tratamiento!</p>
            <div class="countdown">
                <div class="countdown-box">
                    <span id="hours" class="countdown-value">24</span>
                    <span class="countdown-label">Horas</span>
                </div>
                <div class="countdown-box">
                    <span id="minutes" class="countdown-value">00</span>
                    <span class="countdown-label">Minutos</span>
                </div>
                <div class="countdown-box">
                    <span id="seconds" class="countdown-value">00</span>
                    <span class="countdown-label">Segundos</span>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN DE RULETA -->
        <div class="roulette-section" id="rouletteSection">
            <h1>¬°Gira la Ruleta y Gana un Descuento!</h1>
            <p class="referral-offer-text">
                Por cada amigo que invites, ganas un <strong>10% OFF</strong> en tu pr√≥ximo tratamiento si tu amigo saca un turno. ¬°√âl tiene <strong>50% OFF</strong> en su primer servicio!
            </p>
            <p class="spin-count-display" id="spinCountDisplay">Te quedan 3 tiros.</p>
            <div class="roulette-canvas-container">
                <canvas id="rouletteCanvas"></canvas> 
                <div class="wheel-indicator"></div>
            </div>
            <div class="buttons-container">
                <button class="btn btn-spin" id="spinBtn">
                    <i class="fas fa-play-circle"></i> Girar Ruleta
                </button>
                <div class="loading-spinner" id="loadingSpinner"></div>
                <p id="resultMessage"></p>
                <p class="prize-timer" id="prizeTimerDisplay"></p>
                <div class="mercadopago-link-container" id="mercadopagoLinkContainer" style="display: none;">
                    <p>Para reservar tu premio, abona una se√±a de <span id="mercadopagoPriceDisplay"></span> aqu√≠:</p>
                    <a href="#" id="mercadopagoLink" target="_blank">
                        <i class="fas fa-money-bill-wave"></i> Pagar Se√±a con Mercado Pago
                    </a>
                    <!-- Bot√≥n para simular el pago de la se√±a (solo para demostraci√≥n) -->
                    <button class="btn btn-confirm mt-4" id="markSe√±aPaidBtn" style="display: none;">
                        Marcar Se√±a como Pagada (Demo)
                    </button>
                </div>
                <button class="btn btn-use-discount" id="useDiscountBtn">
                    <i class="fas fa-gift"></i> Usar este Descuento
                </button>
            </div>
        </div>
        <!-- FIN SECCI√ìN DE RULETA -->

        <!-- SECCI√ìN DE LISTA DE PRECIOS (NUEVA) -->
        <div class="price-list-section" id="priceListSection">
            <h2>Lista de Precios de Tratamientos</h2>
            <table class="price-list-table">
                <thead>
                    <tr>
                        <th>Tratamiento</th>
                        <th>Precio</th>
                    </tr>
                </thead>
                <tbody id="priceListTableBody">
                    <!-- Los precios se insertar√°n aqu√≠ con JavaScript -->
                </tbody>
            </table>
        </div>
        <!-- FIN SECCI√ìN DE LISTA DE PRECIOS -->

        <div class="referral-promo-diffusion" id="referralPromoDiffusion" style="display: none;">
            <h3>¬°Invita a un amigo y GANA!</h3>
            <p>Si reservas un turno y nos recomiendas a un amigo, obtendr√°s un **5% DE DESCUENTO ADICIONAL** en tu pr√≥xima sesi√≥n cuando tu amigo contrate su primer servicio.</p>
            <button class="btn btn-invite" id="inviteBtnDiffusion">
                <i class="fas fa-user-plus"></i> Invitar a un amigo
            </button>
        </div>
        
        <div class="form-container">
            <div class="disclaimer" id="disclaimerMessage">
                <i class="fas fa-info-circle"></i> Aqu√≠ puedes confirmar tu turno asignado.
                ¬°No olvides la incre√≠ble promoci√≥n de referidos!
            </div>
            <div class="form-group">
                <label for="name">Nombre completo</label>
                <input id="name" placeholder="Ingresa tu nombre completo" type="text"> 
            </div>
            <div class="form-group" id="appointmentDisplayGroup">
                <label>Tu turno est√° asignado para:</label>
                <div id="displayDate"></div> 
            </div>
            <button class="btn btn-confirm" id="confirmBtn">
                <i class="fas fa-calendar-check"></i> CONFIRMAR MI TURNO
            </button>
            <button class="btn btn-invite" id="inviteBtn">
                <i class="fas fa-user-plus"></i> INVITAR A UN AMIGO (50% OFF)
            </button>
        </div>
    </div>
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span>¬°Turno confirmado con √©xito! Te hemos enviado un mensaje por
            WhatsApp.</span>
    </div>
    <a href="https://wa.me/5493415216025?text=Hola%20Le%20Bardol%2C%20quisiera%20consultar%20sobre%20un%20turno." class="whatsapp-icon" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>
    <div class="footer">
        <p>¬© 2023 Le Bardol Est√©tica Center. Todos los derechos reservados.</p>
    </div>
    <script>
        // --- Configuraci√≥n de Mercado Pago (¬°MODIFICA ESTOS VALORES!) ---
        const mercadopagoLinkUrl = 'https://mpago.la/2tpSkE9'; // Tu enlace real de Mercado Pago
        const mercadopagoPrice = '$8000'; // El monto de la se√±a
        // -----------------------------------------------------------------

        // Script para el contador regresivo de 24 horas de la oferta principal
        function startCountdown() {
            const savedTime = localStorage.getItem('countdownEndTime');
            let endTime;
            
            // La fecha actual de Argentina (Buenos Aires)
            const nowArgentina = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Argentina/Buenos_Aires"}));

            if (savedTime) {
                endTime = parseInt(savedTime);
                // Si el tiempo guardado ya pas√≥, rein√≠cialo a 24 horas desde ahora
                if (endTime < nowArgentina.getTime()) {
                    endTime = nowArgentina.getTime() + 24 * 60 * 60 * 1000;
                    localStorage.setItem('countdownEndTime', endTime.toString());
                }
            } else {
                endTime = nowArgentina.getTime() + 24 * 60 * 60 * 1000;
                localStorage.setItem('countdownEndTime', endTime.toString());
            }
            
            const timer = setInterval(() => {
                const now = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Argentina/Buenos_Aires"})); 
                const timeLeft = endTime - now.getTime();
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    document.getElementById('hours').textContent = '00';
                    document.getElementById('minutes').textContent = '00';
                    document.getElementById('seconds').textContent = '00';
                    const isReminderLink = getUrlParameter('fecha') !== '';
                    if (isReminderLink) { 
                           document.getElementById('inviteBtn').disabled = true;
                    }
                    return;
                }
                
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
            }, 1000);
        }
        
        // Funci√≥n para mostrar la notificaci√≥n de confirmaci√≥n
        function showNotification() {
            const notification = document.getElementById('notification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Funci√≥n para validar el formulario antes de enviar (depende del tipo de enlace)
        function validateForm(isReminder) {
            const name = document.getElementById('name').value;
            const displayedDate = document.getElementById('displayDate').textContent;
            
            if (isReminder) { 
                if (!name || name.trim() === '' || name.trim() === "Estimado/a cliente/a" || displayedDate === '' || displayedDate === 'Fecha y hora no v√°lidas' || displayedDate === 'Fecha y hora no asignadas') { 
                    alert('Faltan datos para confirmar tu turno. Por favor, aseg√∫rate de que tu nombre y fecha de turno est√©n visibles y sean correctos.');
                    return false;
                }
            } else { 
            }
            return true;
        }
        
        // Funci√≥n para enviar el mensaje por WhatsApp
        function sendWhatsAppMessage(isReminder, discount, treatment) {
            const name = document.getElementById('name').value;
            const whatsappNumber = '5493415216025'; 
            let message = '';
            const wonRoulettePrize = JSON.parse(localStorage.getItem('wonRoulettePrize')); 
            const prizeSe√±aPaid = localStorage.getItem('prizeSe√±aPaid') === 'true';

            if (isReminder) {
                const displayedDate = document.getElementById('displayDate').textContent; 
                message = `¬°Hola Le Bardol! Soy ${name}. Confirmo mi turno asignado para el ${displayedDate}.`;
                if (wonRoulettePrize && wonRoulettePrize.description && prizeSe√±aPaid) {
                    message += ` Adem√°s, quiero aplicar mi premio de ruleta: ${wonRoulettePrize.description}.`;
                } else if (wonRoulettePrize && wonRoulettePrize.description && !prizeSe√±aPaid && wonRoulettePrize.needsSe√±a) {
                    message += ` Adem√°s, gan√© un premio de ruleta: ${wonRoulettePrize.description}. Estoy gestionando el pago de la se√±a.`;
                }
                message += ` Agradezco su confirmaci√≥n. ¬°Saludos!`;
            } else {
                let offerText = "";
                if (discount && treatment) {
                    offerText = `Estoy interesado/a en la promo de ${discount}% de descuento en ${treatment}.`;
                } else if (discount) {
                    offerText = `Estoy interesado/a en la promo de ${discount}% de descuento.`;
                } else if (treatment) {
                    offerText = `Estoy interesado/a en la promo de ${treatment}.`;
                } else {
                    offerText = `Estoy interesado/a en sus servicios y promociones.`;
                }
                message = `¬°Hola Le Bardol! Mi nombre es ${name}. ${offerText} ¬øPodr√≠an brindarme m√°s informaci√≥n o ayudarme a sacar un turno? ¬°Gracias!`;
            }

            // Si hay un premio de ruleta ganado que requiere se√±a y no ha sido pagada
            if (wonRoulettePrize && wonRoulettePrize.needsSe√±a && !prizeSe√±aPaid) {
                message += `\n\nPara reservar mi premio (${wonRoulettePrize.description}), abonar√© la se√±a de ${mercadopagoPrice}.`;
                message += `\nLink de se√±a: ${mercadopagoLinkUrl}`; 
            }
            
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // Funci√≥n para compartir la invitaci√≥n (bot√≥n 50% OFF)
        function shareInvitation() {
            const referrerName = document.getElementById('name').value;
            const referrerDiscount = getUrlParameter('descuentoReferente') || '10'; 
            const newClientDiscount = getUrlParameter('descuentoNuevoCliente') || '50'; 
            const friendRouletteDiscount = localStorage.getItem('friendRouletteDiscount'); 

            if (!referrerName || referrerName.trim() === '' || referrerName.trim() === 'Estimado/a cliente/a' || referrerName.trim() === 'Hola!') { 
                alert('Por favor, ingresa tu nombre completo para que tus amigos sepan qui√©n los env√≠a.');
                document.getElementById('name').focus();
                return;
            }

            const whatsappNumberLeBardol = '5493415216025'; 
            
            const finalNewClientDiscount = friendRouletteDiscount ? friendRouletteDiscount : newClientDiscount;

            const messageForFriend = `¬°Hola Le Bardol! Me interesa la promo del ${finalNewClientDiscount}% de descuento en mi primer servicio. Me recomend√≥ ${referrerName}. ¬°Quisiera m√°s informaci√≥n!`;
            
            const referralLink = `https://wa.me/${whatsappNumberLeBardol}?text=${encodeURIComponent(messageForFriend)}`;
            
            const sharedMessage = `¬°Hola! Te recomiendo Le Bardol Est√©tica Center. ¬°Est√°n ofreciendo un ${finalNewClientDiscount}% de descuento en tu primer tratamiento! Solo tienes que contactarlos mencionando que te envi√≥ ${referrerName} para obtener la promo. Adem√°s, por cada amigo que contrate, ¬°yo obtengo un <strong>${referrerDiscount}% de descuento</strong> en mi pr√≥ximo servicio!\n\nüëâ Cont√°ctalos aqu√≠ y obt√©n tu descuento: ${referralLink}`;
            
            window.open(`https://wa.me/?text=${encodeURIComponent(sharedMessage)}`, '_blank');
        }

        // Funci√≥n para compartir la invitaci√≥n desde la nueva tarjeta de difusi√≥n (5% OFF)
        function shareInvitationDiffusion() {
            const whatsappNumberLeBardol = '5493415216025'; 
            const nameFromInput = document.getElementById('name').value;
            const referrerName = (nameFromInput && nameFromInput.trim() !== '' && nameFromInput.trim() !== 'Hola!') ? nameFromInput : 'un amigo/a';

            const diffusionReferrerDiscount = getUrlParameter('descuentoReferenteDifusion') || '5'; 
            const diffusionNewClientDiscount = getUrlParameter('descuentoNuevoClienteDifusion') || '5'; 

            const messageForFriend = `¬°Hola Le Bardol! Me interesa la promo de referido. Me envi√≥ ${referrerName} y quiero mi ${diffusionNewClientDiscount}% de descuento en mi primer servicio.`;
            
            const referralLink = `https://wa.me/${whatsappNumberLeBardol}?text=${encodeURIComponent(messageForFriend)}`;
            
            const sharedMessage = `¬°Hola! Te recomiendo Le Bardol Est√©tica Center. ¬°Si mencionas que te envi√©, obtienes un <strong>${diffusionNewClientDiscount}% de descuento</strong> en tu primer servicio, y yo tambi√©n gano un <strong>${diffusionReferrerDiscount}% de descuento</strong> en mi pr√≥xima sesi√≥n!\n\nüëâ Cont√°ctalos aqu√≠ y obt√©n tu descuento: ${referralLink}`;
            
            window.open(`https://wa.me/?text=${encodeURIComponent(sharedMessage)}`, '_blank');
        }

        // Funci√≥n para habilitar/deshabilitar el bot√≥n de invitaci√≥n del recordatorio
        function toggleInviteButton() {
            const nameInput = document.getElementById('name');
            const inviteBtn = document.getElementById('inviteBtn');
            if (nameInput.value.trim() === '' || nameInput.value.trim() === 'Estimado/a cliente/a' || nameInput.value.trim() === 'Hola!') {
                inviteBtn.disabled = true;
            } else {
                inviteBtn.disabled = false;
            }
        }

        // Funci√≥n para obtener par√°metros de la URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // --- L√≥gica de la Ruleta ---
        const canvas = document.getElementById('rouletteCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const useDiscountBtn = document.getElementById('useDiscountBtn');
        const resultMessage = document.getElementById('resultMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const rouletteSection = document.getElementById('rouletteSection'); 
        const spinCountDisplay = document.getElementById('spinCountDisplay'); 
        const prizeTimerDisplay = document.getElementById('prizeTimerDisplay'); 
        const mercadopagoLinkContainer = document.getElementById('mercadopagoLinkContainer'); 
        const mercadopagoLink = document.getElementById('mercadopagoLink'); 
        const mercadopagoPriceDisplay = document.getElementById('mercadopagoPriceDisplay'); 
        const markSe√±aPaidBtn = document.getElementById('markSe√±aPaidBtn'); // Nuevo bot√≥n para simular pago de se√±a

        // Definici√≥n de los segmentos de la ruleta con tipos de premio
        const segments = [
            { text: '20% OFF Sesi√≥n Depi', type: 'discount', value: 20, category: 'depilacion', description: '20% de descuento en sesi√≥n de depilaci√≥n', needsSe√±a: true },
            { text: '30% OFF Pack Depi', type: 'discount', value: 30, category: 'depilacion', description: '30% de descuento en paquete de depilaci√≥n', needsSe√±a: true },
            { text: 'Nuevo Tiro!', type: 'new_spin', description: '¬°Un nuevo tiro en la ruleta!', needsSe√±a: false },
            { text: '20% OFF Pack Masajes', type: 'discount', value: 20, category: 'masajes', description: '20% de descuento en paquete de masajes', needsSe√±a: true },
            { text: '35% OFF Pack Depi', type: 'discount', value: 35, category: 'depilacion', description: '35% de descuento en paquete de depilaci√≥n', needsSe√±a: true },
            { text: 'No ganaste nada', type: 'no_luck', description: 'No ganaste nada. ¬°Mejor suerte la pr√≥xima!', needsSe√±a: false },
            { text: '30% OFF Manicura', type: 'discount', value: 30, category: 'manicura', description: '30% de descuento en manicura', needsSe√±a: true },
            { text: 'Nuevo Tiro!', type: 'new_spin', description: '¬°Un nuevo tiro en la ruleta!', needsSe√±a: false },
            { text: '30% OFF Cosmetologia', type: 'discount', value: 30, category: 'cosmetologia', description: '30% de descuento en cosmetolog√≠a', needsSe√±a: true },
            { text: '20% OFF Masajes', type: 'discount', value: 20, category: 'masajes', description: '20% de descuento en masajes', needsSe√±a: true },
            { text: 'Comod√≠n 30% OFF', type: 'discount', value: 30, category: 'comodin', description: 'Comod√≠n 30% de descuento en cualquier servicio', needsSe√±a: true },
            { text: 'Nuevo Tiro!', type: 'new_spin', description: '¬°Un nuevo tiro en la ruleta!', needsSe√±a: false },
        ];

        const segmentColors = ['#FFC0CB', '#FFB6C1', '#FFDAB9', '#FFE4E1', '#F0F8FF', '#E6E6FA']; // Colores pastel
        const numSegments = segments.length;
        const arc = (2 * Math.PI) / numSegments; // √Ångulo de cada segmento en radianes

        const ROULETTE_MAX_SPINS = 3;
        const ROULETTE_LOCKOUT_DURATION_MS = 30 * 60 * 1000; // 30 minutos en milisegundos
        const ROULETTE_RESET_DURATION_MS = 24 * 60 * 60 * 1000; // 24 horas en milisegundos
        const PRIZE_SE√ëA_DURATION_MS = 30 * 60 * 1000; // 30 minutos para la se√±a

        let rouletteSpinsLeft = ROULETTE_MAX_SPINS;
        let rouletteLastSpinCycleStartTimestamp = 0;
        let rouletteLockoutEndTime = 0;
        let wonRoulettePrize = null; // Objeto del premio ganado
        let prizeEndTime = 0; // Tiempo l√≠mite para "se√±al" el premio
        let prizeSe√±aPaid = false; // Bandera para indicar si la se√±a fue pagada

        let rouletteTimerInterval; // Para el contador regresivo de la ruleta
        let prizeTimerInterval; // Para el contador regresivo del premio

        /**
         * Guarda el estado actual de la ruleta en localStorage.
         */
        function saveRouletteState() {
            localStorage.setItem('rouletteSpinsLeft', rouletteSpinsLeft);
            localStorage.setItem('rouletteLastSpinCycleStartTimestamp', rouletteLastSpinCycleStartTimestamp);
            localStorage.setItem('rouletteLockoutEndTime', rouletteLockoutEndTime);
            localStorage.setItem('wonRoulettePrize', JSON.stringify(wonRoulettePrize));
            localStorage.setItem('prizeEndTime', prizeEndTime);
            localStorage.setItem('prizeSe√±aPaid', prizeSe√±aPaid);
        }

        /**
         * Carga el estado de la ruleta desde localStorage.
         */
        function loadRouletteState() {
            const savedSpinsLeft = localStorage.getItem('rouletteSpinsLeft');
            const savedLastSpinCycleStartTimestamp = localStorage.getItem('rouletteLastSpinCycleStartTimestamp');
            const savedLockoutEndTime = localStorage.getItem('rouletteLockoutEndTime');
            const savedWonPrize = localStorage.getItem('wonRoulettePrize');
            const savedPrizeEndTime = localStorage.getItem('prizeEndTime');
            const savedPrizeSe√±aPaid = localStorage.getItem('prizeSe√±aPaid');

            if (savedSpinsLeft !== null) rouletteSpinsLeft = parseInt(savedSpinsLeft, 10);
            if (savedLastSpinCycleStartTimestamp !== null) rouletteLastSpinCycleStartTimestamp = parseInt(savedLastSpinCycleStartTimestamp, 10);
            if (savedLockoutEndTime !== null) rouletteLockoutEndTime = parseInt(savedLockoutEndTime, 10);
            if (savedWonPrize !== null && savedWonPrize !== 'null') wonRoulettePrize = JSON.parse(savedWonPrize);
            if (savedPrizeEndTime !== null) prizeEndTime = parseInt(savedPrizeEndTime, 10);
            if (savedPrizeSe√±aPaid !== null) prizeSe√±aPaid = (savedPrizeSe√±aPaid === 'true');
        }

        /**
         * Ajusta el tama√±o del canvas para que sea responsivo.
         */
        function resizeCanvas() {
            const container = document.querySelector('.roulette-canvas-container');
            const computedStyle = getComputedStyle(container);
            const containerWidth = parseFloat(computedStyle.width); 

            canvas.width = containerWidth;
            canvas.height = containerWidth; 
            drawRoulette(currentRotation); // Redibuja la ruleta despu√©s del redimensionamiento
        }

        /**
         * Dibuja la ruleta en el canvas.
         * @param {number} rotation - La rotaci√≥n actual de la ruleta en radianes.
         */
        function drawRoulette(rotation = 0) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 20; // Un poco m√°s peque√±o para el borde

            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(rotation);

            for (let i = 0; i < numSegments; i++) {
                const angle = i * arc;
                const color = segmentColors[i % segmentColors.length];

                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + arc);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#4a2c5e'; // Borde de los segmentos
                ctx.lineWidth = 2;
                ctx.stroke();

                // Dibujar texto del segmento
                ctx.save();
                // Rotar el contexto para que el texto est√© alineado con el segmento
                ctx.rotate(angle + arc / 2); 
                ctx.fillStyle = '#4a2c5e'; // Color del texto
                
                // Tama√±o de fuente responsivo: 5.5% del ancho del canvas, con un m√≠nimo de 18px y un m√°ximo de 30px
                const fontSize = Math.max(18, Math.min(30, canvas.width * 0.055)); 
                ctx.font = `bold ${fontSize}px sans-serif`; 
                ctx.textAlign = 'center'; // Centrar el texto en el punto de dibujo
                ctx.textBaseline = 'middle';
                
                // Posicionar el texto a una distancia del centro.
                // Si el texto es largo, `radius * 0.5` podr√≠a ser mejor.
                // Si el texto es corto, `radius * 0.7` podr√≠a ser mejor.
                // Ajustamos a 0.6 para un balance.
                ctx.fillText(segments[i].text, radius * 0.6, 0); 
                ctx.restore();
            }
            ctx.restore();
        }

        let animationFrameId; // Para controlar el requestAnimationFrame

        /**
         * Anima el giro de la ruleta.
         * @param {number} finalAngle - El √°ngulo final de rotaci√≥n en radianes.
         * @param {number} duration - Duraci√≥n de la animaci√≥n en milisegundos.
         */
        function animateRoulette(finalAngle, duration) {
            const startAngle = currentRotation; // Usar la rotaci√≥n actual como punto de partida
            const startTime = performance.now();

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // Curva de aceleraci√≥n/desaceleraci√≥n (cubic-bezier(0.25, 0.1, 0.25, 1))
                const easedProgress = 1 - Math.pow(1 - progress, 3); // Simula ease-out cubic

                currentRotation = startAngle + (finalAngle - startAngle) * easedProgress;
                drawRoulette(currentRotation);

                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animate);
                } else {
                    // Normalizar la rotaci√≥n para evitar valores muy grandes
                    currentRotation = finalAngle % (2 * Math.PI);
                    drawRoulette(currentRotation);
                    handleSpinEnd();
                }
            }
            animationFrameId = requestAnimationFrame(animate);
        }

        let currentRotation = 0; // Rotaci√≥n actual de la ruleta en radianes

        /**
         * Maneja el final del giro de la ruleta.
         */
        function handleSpinEnd() {
            loadingSpinner.style.display = 'none';
            spinBtn.disabled = false; // Habilitar el bot√≥n si hay giros restantes

            // Calcular el segmento ganador:
            // El puntero est√° fijo en la parte superior del canvas.
            // Si el canvas no est√° rotado, la parte superior es -PI/2 o 1.5 * PI radianes desde el eje X positivo (derecha).
            // La rotaci√≥n de la rueda (currentRotation) es en sentido horario desde el eje X positivo.
            // Para saber qu√© segmento est√° bajo el puntero, necesitamos el √°ngulo del puntero en el sistema de coordenadas de la rueda.
            // Si el puntero est√° en 1.5 * PI (top) y la rueda ha girado `currentRotation` (clockwise),
            // entonces el punto de la rueda que est√° bajo el puntero estaba originalmente en (1.5 * PI - currentRotation).
            let angleAtPointerOnWheel = (1.5 * Math.PI - (currentRotation % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
            
            // Determinar el √≠ndice del segmento que contiene este √°ngulo
            // Los segmentos se dibujan desde 0 (derecha) en sentido horario.
            let winningSegmentIndex = Math.floor(angleAtPointerOnWheel / arc);
            
            // Ajustar si el √°ngulo cae exactamente en el l√≠mite entre dos segmentos
            if (winningSegmentIndex === numSegments) {
                winningSegmentIndex = 0;
            }

            const winningPrize = segments[winningSegmentIndex];
            wonRoulettePrize = winningPrize;
            localStorage.setItem('wonRoulettePrize', JSON.stringify(wonRoulettePrize));

            resultMessage.textContent = `¬°Felicidades! Ganaste: ${winningPrize.description}`;
            resultMessage.style.color = '#e91e63'; // Color para el mensaje de resultado

            // L√≥gica para la se√±a y el bot√≥n "Usar Descuento"
            if (winningPrize.needsSe√±a) {
                prizeEndTime = Date.now() + PRIZE_SE√ëA_DURATION_MS;
                prizeSe√±aPaid = false; // Reiniciar estado de pago de se√±a
                mercadopagoPriceDisplay.textContent = mercadopagoPrice;
                mercadopagoLink.href = mercadopagoLinkUrl;
                mercadopagoLinkContainer.style.display = 'block';
                markSe√±aPaidBtn.style.display = 'block'; // Mostrar bot√≥n de demo
                useDiscountBtn.style.display = 'none'; // Ocultar hasta que se pague la se√±a
                startPrizeTimer();
            } else {
                prizeEndTime = 0; // No hay tiempo l√≠mite para se√±a
                prizeSe√±aPaid = true; // No necesita se√±a, se considera pagado
                mercadopagoLinkContainer.style.display = 'none';
                markSe√±aPaidBtn.style.display = 'none';
                useDiscountBtn.style.display = 'block'; // Mostrar bot√≥n "Usar Descuento"
                useDiscountBtn.disabled = false;
            }

            // L√≥gica para premios de "Nuevo Tiro" o "Nuevo Tiro + Amigo"
            if (winningPrize.type === 'new_spin' || winningPrize.type === 'new_spin_friend_discount') {
                rouletteSpinsLeft++; // Dar un giro adicional
                if (winningPrize.type === 'new_spin_friend_discount') {
                    localStorage.setItem('friendRouletteDiscount', winningPrize.friendDiscount);
                }
            } else if (winningPrize.type === 'no_luck_new_spin' || winningPrize.type === 'no_luck') { // Incluir 'no_luck'
                // No hay descuento, pero se mantiene el giro para el pr√≥ximo intento
                // No se decrementa el giro aqu√≠, ya se hizo al inicio del spinRoulette
            }

            saveRouletteState();
            updateRouletteUI(); // Actualiza la UI de la ruleta despu√©s del giro
            checkRouletteStatus(); // Revisa el estado general de la ruleta
        }

        /**
         * Inicia el temporizador para la se√±a del premio.
         */
        function startPrizeTimer() {
            if (prizeTimerInterval) clearInterval(prizeTimerInterval);

            prizeTimerDisplay.style.display = 'block';
            prizeTimerInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = prizeEndTime - now;

                if (timeLeft <= 0) {
                    clearInterval(prizeTimerInterval);
                    prizeTimerDisplay.textContent = 'Tiempo para se√±a expirado.';
                    prizeTimerDisplay.style.color = '#e53e3e'; // Rojo para expirado
                    useDiscountBtn.disabled = true; // Deshabilitar bot√≥n de usar descuento
                    mercadopagoLinkContainer.style.display = 'none'; // Ocultar enlace de MP
                    markSe√±aPaidBtn.style.display = 'none'; // Ocultar bot√≥n de demo
                    wonRoulettePrize = null; // El premio se pierde
                    localStorage.removeItem('wonRoulettePrize');
                    localStorage.removeItem('prizeEndTime');
                    localStorage.removeItem('prizeSe√±aPaid');
                    saveRouletteState(); // Guardar el estado actualizado
                    return;
                }

                const minutes = Math.floor(timeLeft / (60 * 1000));
                const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
                prizeTimerDisplay.textContent = `Tiempo para se√±ar: ${minutes}m ${seconds}s`;
                prizeTimerDisplay.style.color = '#007bb6'; // Color azul para el temporizador
            }, 1000);
        }

        /**
         * Actualiza la interfaz de usuario de la secci√≥n de la ruleta.
         */
        function updateRouletteUI() {
            spinCountDisplay.textContent = `Te quedan ${rouletteSpinsLeft} tiros.`;
            mercadopagoPriceDisplay.textContent = mercadopagoPrice; // Asegura que el precio se muestre

            const now = Date.now();

            if (rouletteSpinsLeft === 0) {
                if (now < rouletteLockoutEndTime) {
                    // Bloqueo general de 30 minutos activo (si no hay premio con se√±a)
                    const remainingLockout = rouletteLockoutEndTime - now;
                    const minutes = Math.floor(remainingLockout / (60 * 1000));
                    const seconds = Math.floor((remainingLockout % (60 * 1000)) / 1000);
                    spinBtn.textContent = `Bloqueado: ${minutes}m ${seconds}s`;
                    spinBtn.disabled = true;
                    resultMessage.textContent = 'Has agotado tus tiros. Espera para volver a girar.';
                    resultMessage.style.color = '#e53e3e';
                } else if (now < (rouletteLastSpinCycleStartTimestamp + ROULETTE_RESET_DURATION_MS)) {
                    // Esperando el reinicio de 24 horas
                    const remainingReset = (rouletteLastSpinCycleStartTimestamp + ROULETTE_RESET_DURATION_MS) - now;
                    const hours = Math.floor(remainingReset / (60 * 60 * 1000));
                    const minutes = Math.floor((remainingReset % (60 * 60 * 1000)) / (60 * 1000));
                    spinBtn.textContent = `Reinicia en: ${hours}h ${minutes}m`;
                    spinBtn.disabled = true;
                    resultMessage.textContent = 'Tiros agotados. Espera 24 horas para un nuevo ciclo.';
                    resultMessage.style.color = '#e53e3e';
                } else {
                    // Reinicio de 24 horas completado
                    resetRouletteCycle();
                }
            } else {
                // Hay giros disponibles
                spinBtn.textContent = '¬°Girar Ruleta!';
                spinBtn.disabled = false;
                resultMessage.textContent = ''; // Limpiar mensaje si hay giros
            }

            // L√≥gica para el premio ganado y la se√±a
            if (wonRoulettePrize) {
                resultMessage.textContent = `¬°Felicidades! Ganaste: ${wonRoulettePrize.description}`;
                resultMessage.style.color = '#e91e63';

                if (wonRoulettePrize.needsSe√±a) {
                    mercadopagoLinkContainer.style.display = 'block';
                    markSe√±aPaidBtn.style.display = 'block'; // Mostrar bot√≥n de demo
                    if (!prizeSe√±aPaid && now < prizeEndTime) {
                        // Si no se ha pagado la se√±a y el tiempo no ha expirado
                        useDiscountBtn.style.display = 'none';
                        startPrizeTimer(); // Asegura que el temporizador est√© corriendo
                    } else if (prizeSe√±aPaid) {
                        // Si la se√±a ya fue pagada
                        prizeTimerDisplay.style.display = 'none';
                        mercadopagoLinkContainer.style.display = 'none';
                        markSe√±aPaidBtn.style.display = 'none';
                        useDiscountBtn.style.display = 'block';
                        useDiscountBtn.disabled = false;
                    } else {
                        // Si el tiempo de se√±a expir√≥
                        prizeTimerDisplay.textContent = 'Tiempo para se√±a expirado.';
                        prizeTimerDisplay.style.color = '#e53e3e';
                        mercadopagoLinkContainer.style.display = 'none';
                        markSe√±aPaidBtn.style.display = 'none';
                        useDiscountBtn.style.display = 'none'; // Ocultar bot√≥n de usar descuento
                        wonRoulettePrize = null; // El premio se pierde
                        localStorage.removeItem('wonRoulettePrize');
                        localStorage.removeItem('prizeEndTime');
                        localStorage.removeItem('prizeSe√±aPaid');
                        saveRouletteState();
                        updateRouletteUI(); // Recargar UI para reflejar la p√©rdida del premio
                    }
                } else {
                    // Si el premio no necesita se√±a
                    prizeTimerDisplay.style.display = 'none';
                    mercadopagoLinkContainer.style.display = 'none';
                    markSe√±aPaidBtn.style.display = 'none';
                    useDiscountBtn.style.display = 'block';
                    useDiscountBtn.disabled = false;
                }
            } else {
                // No hay premio ganado actualmente
                resultMessage.textContent = '';
                prizeTimerDisplay.style.display = 'none';
                mercadopagoLinkContainer.style.display = 'none';
                markSe√±aPaidBtn.style.display = 'none';
                useDiscountBtn.style.display = 'none';
            }
            saveRouletteState(); // Guardar cualquier cambio de estado
        }

        /**
         * Restablece el ciclo de juego de la ruleta (giros y temporizadores).
         */
        function resetRouletteCycle() {
            rouletteSpinsLeft = ROULETTE_MAX_SPINS;
            rouletteLastSpinCycleStartTimestamp = Date.now();
            rouletteLockoutEndTime = 0;
            wonRoulettePrize = null;
            prizeEndTime = 0;
            prizeSe√±aPaid = false;
            localStorage.removeItem('friendRouletteDiscount'); // Limpiar descuento de amigo
            saveRouletteState();
            updateRouletteUI();
            if (rouletteTimerInterval) clearInterval(rouletteTimerInterval);
            if (prizeTimerInterval) clearInterval(prizeTimerInterval);
            resultMessage.textContent = '';
        }

        /**
         * Verifica el estado de la ruleta al cargar la p√°gina.
         */
        function checkRouletteStatus() {
            loadRouletteState();
            const now = Date.now();

            // Si el ciclo de 24 horas ha pasado o es la primera vez
            if (rouletteLastSpinCycleStartTimestamp === 0 || now >= (rouletteLastSpinCycleStartTimestamp + ROULETTE_RESET_DURATION_MS)) {
                resetRouletteCycle();
            } else if (rouletteSpinsLeft === 0 && now < rouletteLockoutEndTime) {
                // Si est√° en bloqueo de 30 minutos
                if (rouletteTimerInterval) clearInterval(rouletteTimerInterval);
                rouletteTimerInterval = setInterval(updateRouletteUI, 1000);
            } else if (rouletteSpinsLeft === 0 && now >= rouletteLockoutEndTime && now < (rouletteLastSpinCycleStartTimestamp + ROULETTE_RESET_DURATION_MS)) {
                // Si el bloqueo de 30 minutos termin√≥ pero no las 24 horas
                if (rouletteTimerInterval) clearInterval(rouletteTimerInterval); // Detener el temporizador de 30min si ya pas√≥
                rouletteTimerInterval = setInterval(updateRouletteUI, 1000); // Iniciar temporizador de 24h
            }

            // Si hay un premio ganado y necesita se√±a, y el tiempo de se√±a no ha expirado
            if (wonRoulettePrize && wonRoulettePrize.needsSe√±a && !prizeSe√±aPaid && now < prizeEndTime) {
                startPrizeTimer();
            } else if (wonRoulettePrize && wonRoulettePrize.needsSe√±a && !prizeSe√±aPaid && now >= prizeEndTime) {
                // Si el premio necesitaba se√±a y el tiempo expir√≥
                wonRoulettePrize = null;
                prizeEndTime = 0;
                prizeSe√±aPaid = false;
                localStorage.removeItem('wonRoulettePrize');
                localStorage.removeItem('prizeEndTime');
                localStorage.removeItem('prizeSe√±aPaid');
                saveRouletteState();
            }
            updateRouletteUI();
            drawRoulette(currentRotation); // Ensure initial draw
        }

        // Event Listeners
        spinBtn.addEventListener('click', () => {
            if (rouletteSpinsLeft > 0) {
                loadingSpinner.style.display = 'block';
                spinBtn.disabled = true;
                rouletteSpinsLeft--; // Decrementar el giro al inicio
                saveRouletteState(); // Guardar el estado de los giros
                updateRouletteUI(); // Actualizar la UI inmediatamente
                
                const randomSegmentIndex = Math.floor(Math.random() * numSegments);
                
                // Calculate the target angle for the *center* of the winning segment
                // The pointer is at 12 o'clock (top), which is 1.5 * Math.PI radians (270 degrees) clockwise from 3 o'clock.
                // The center of segment `randomSegmentIndex` is at `(randomSegmentIndex * arc + arc / 2)` radians from 3 o'clock.
                // We want to rotate the wheel so that `(randomSegmentIndex * arc + arc / 2)` aligns with `1.5 * Math.PI`.
                // So, the rotation needed is `(1.5 * Math.PI - (randomSegmentIndex * arc + arc / 2))`.
                // This value can be negative, meaning it needs to rotate counter-clockwise or wrap around.
                
                let targetAngleRelativeToZero = (1.5 * Math.PI - (randomSegmentIndex * arc + arc / 2));
                
                // Normalize this angle to be between 0 and 2*PI
                targetAngleRelativeToZero = (targetAngleRelativeToZero % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);

                // Calculate the total angle to spin, ensuring it's always forward and includes extra rotations
                const extraRotations = 5; // Minimum 5 full spins for visual effect
                let angleToReach = targetAngleRelativeToZero - (currentRotation % (2 * Math.PI));
                if (angleToReach < 0) {
                    angleToReach += (2 * Math.PI); // Ensure it spins forward to the target
                }
                const absoluteFinalAngle = currentRotation + angleToReach + (extraRotations * 2 * Math.PI);

                animateRoulette(absoluteFinalAngle, 6000); // 6 seconds duration
            } else {
                updateRouletteUI(); // Asegurarse de que el mensaje de bloqueo se muestre
            }
        });

        // Event listener para el bot√≥n "Marcar Se√±a como Pagada (Demo)"
        markSe√±aPaidBtn.addEventListener('click', () => {
            prizeSe√±aPaid = true;
            localStorage.setItem('prizeSe√±aPaid', 'true');
            if (prizeTimerInterval) clearInterval(prizeTimerInterval); // Detener el temporizador de se√±a
            updateRouletteUI(); // Actualizar la UI para mostrar el bot√≥n "Usar Descuento"
            alert('Se√±a marcada como pagada. Ahora puedes usar tu descuento.'); // Alerta de demostraci√≥n
        });

        useDiscountBtn.addEventListener('click', () => {
            if (wonRoulettePrize) {
                // Aqu√≠ podr√≠as redirigir a una p√°gina de reserva con el descuento aplicado
                // o mostrar un modal con los detalles para usarlo.
                alert(`¬°Has usado tu premio: ${wonRoulettePrize.description}! Presenta este mensaje en caja.`);
                // Limpiar el premio despu√©s de usarlo para que no se pueda usar de nuevo
                wonRoulettePrize = null;
                prizeEndTime = 0;
                prizeSe√±aPaid = false;
                localStorage.removeItem('wonRoulettePrize');
                localStorage.removeItem('prizeEndTime');
                localStorage.removeItem('prizeSe√±aPaid');
                localStorage.removeItem('friendRouletteDiscount'); // Limpiar descuento de amigo si se usa
                saveRouletteState();
                updateRouletteUI(); // Actualizar la UI para reflejar que el premio fue usado
            }
        });

        // --- L√≥gica de la Lista de Precios (Existente) ---
        const priceList = [
            { treatment: 'Limpieza Facial Profunda', price: '$5000' },
            { treatment: 'Peeling Qu√≠mico', price: '$7000' },
            { treatment: 'Radiofrecuencia Facial', price: '$6000' },
            { treatment: 'Drenaje Linf√°tico', price: '$4500' },
            { treatment: 'Masaje Relajante (60 min)', price: '$5500' },
            { treatment: 'Manicur√≠a Completa', price: '$2000' },
            { treatment: 'Pedicur√≠a Completa', price: '$3000' },
            { treatment: 'Perfilado de Cejas', price: '$1500' },
            { treatment: 'Lifting de Pesta√±as', price: '$3500' }
        ];

        function populatePriceList(customPrices = null) {
            const priceListTableBody = document.getElementById('priceListTableBody');
            priceListTableBody.innerHTML = ''; // Limpiar tabla

            let pricesToDisplay = [];
            const isRoulettePage = getUrlParameter('roulette') === 'true';
            const hasRouletteDiscount = getUrlParameter('rouletteDiscount') !== '';

            if (customPrices && customPrices.length > 0) {
                pricesToDisplay = customPrices;
            } else if (!isRoulettePage || hasRouletteDiscount) { // Show default prices if not a pure roulette link OR if it's a roulette link with a pre-defined discount
                pricesToDisplay = priceList;
            }

            if (pricesToDisplay.length > 0) {
                document.getElementById('priceListSection').style.display = 'block'; // Ensure it's visible if there are prices
                pricesToDisplay.forEach(item => {
                    const row = priceListTableBody.insertRow();
                    const cell1 = row.insertCell();
                    const cell2 = row.insertCell();
                    cell1.textContent = item.name || item.treatment; // Use 'name' from URL, 'treatment' from default
                    cell2.textContent = item.price;
                });
            } else {
                document.getElementById('priceListSection').style.display = 'none'; // Hide if no prices
            }
        }

        // --- L√≥gica de la P√°gina Principal (Existente) ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlPricesParam = getUrlParameter('prices');
            let customPricesFromUrl = null;
            if (urlPricesParam) {
                try {
                    customPricesFromUrl = JSON.parse(urlPricesParam);
                } catch (e) {
                    console.error('Error parsing prices from URL:', e);
                    customPricesFromUrl = null; // Invalid JSON, revert to null
                }
            }

            // Mostrar u ocultar la secci√≥n de la ruleta si hay un par√°metro 'ruleta' en la URL
            const showRoulette = getUrlParameter('roulette');
            const urlRouletteDiscount = getUrlParameter('rouletteDiscount'); // Obtener el descuento de ruleta de la URL

            if (showRoulette === 'true' && !urlRouletteDiscount) { // Si es enlace de ruleta y NO trae un descuento predefinido
                rouletteSection.style.display = 'block';
                // Ocultar la oferta principal si se muestra la ruleta
                document.getElementById('mainOfferCard').style.display = 'none';
                document.getElementById('referralPromoDiffusion').style.display = 'block'; // Asegurar que la difusi√≥n est√© visible
                
                // Controla la visibilidad de la secci√≥n de precios
                if (!customPricesFromUrl || customPricesFromUrl.length === 0) {
                    document.getElementById('priceListSection').style.display = 'none';
                } else {
                    document.getElementById('priceListSection').style.display = 'block'; // Show if custom prices exist
                }
                checkRouletteStatus(); // Iniciar la l√≥gica de la ruleta
            } else if (urlRouletteDiscount) { // Si es enlace de ruleta y S√ç trae un descuento predefinido
                rouletteSection.style.display = 'none'; // Ocultar la secci√≥n de la ruleta para mostrar el premio directamente
                document.getElementById('mainOfferCard').style.display = 'block'; 
                document.getElementById('referralPromoDiffusion').style.display = 'block';
                document.getElementById('priceListSection').style.display = 'block'; // Siempre mostrar lista de precios si hay un descuento predefinido

                // Configurar el premio ganado directamente desde la URL
                wonRoulettePrize = {
                    text: `${urlRouletteDiscount}% OFF`,
                    type: 'discount',
                    value: parseInt(urlRouletteDiscount),
                    category: 'url_prize',
                    description: `${urlRouletteDiscount}% de descuento (Premio de Ruleta)`,
                    needsSe√±a: true // Asumimos que un premio directo de URL tambi√©n necesita se√±a
                };
                prizeSe√±aPaid = false; // La se√±a no est√° pagada por defecto al llegar con un premio de URL
                prizeEndTime = Date.now() + PRIZE_SE√ëA_DURATION_MS; // Iniciar temporizador de se√±a
                saveRouletteState(); // Guardar el premio en localStorage

                // Actualizar la UI para mostrar el premio y el temporizador de se√±a
                updateRouletteUI();

                // Ajustar el t√≠tulo y descripci√≥n de la oferta principal para el premio de ruleta
                document.getElementById('offerTitle').textContent = `¬°Tu Descuento de Ruleta: ${urlRouletteDiscount}% OFF!`;
                document.getElementById('offerDescription').innerHTML = `¬°Felicidades! Has ganado <strong>${wonRoulettePrize.description}</strong>. Utiliza el bot√≥n "CONFIRMAR MI TURNO" para contactarnos y aplicar tu premio.`;
                
                // Mostrar los botones relevantes para el premio
                document.getElementById('confirmBtn').style.display = 'block';
                document.getElementById('inviteBtn').style.display = 'none';
                document.getElementById('inviteBtnDiffusion').style.display = 'none';
                document.getElementById('disclaimerMessage').style.display = 'block';
                document.getElementById('disclaimerMessage').innerHTML = '<i class="fas fa-bullhorn"></i> ¬°Usa tu descuento de la ruleta! Completa tus datos para contactarnos.';
                
            } else { // Comportamiento por defecto (sin par√°metros de ruleta)
                rouletteSection.style.display = 'none';
                // Mostrar la oferta principal y la difusi√≥n por defecto
                document.getElementById('mainOfferCard').style.display = 'block';
                document.getElementById('referralPromoDiffusion').style.display = 'block';
                document.getElementById('priceListSection').style.display = 'block'; // Siempre mostrar lista de precios por defecto
            }


            const confirmBtn = document.getElementById('confirmBtn');
            const inviteBtn = document.getElementById('inviteBtn');
            const inviteBtnDiffusion = document.getElementById('inviteBtnDiffusion');
            const nameInput = document.getElementById('name');
            const appointmentDisplayGroup = document.getElementById('appointmentDisplayGroup');
            const disclaimerMessage = document.getElementById('disclaimerMessage');
            const mainTitle = document.getElementById('mainTitle');
            const offerTitle = document.getElementById('offerTitle');
            const offerDescription = document.getElementById('offerDescription');

            // L√≥gica para el enlace de recordatorio de turno
            const appointmentDateParam = getUrlParameter('fecha');
            const clientNameParam = getUrlParameter('nombre');
            const isReminderLink = appointmentDateParam !== '';

            if (isReminderLink) {
                appointmentDisplayGroup.style.display = 'block';
                disclaimerMessage.innerHTML = '<i class="fas fa-info-circle"></i> Aqu√≠ puedes confirmar tu turno asignado.';
                mainTitle.textContent = 'Confirmaci√≥n de Turno';
                // La descripci√≥n de la oferta se ajustar√° m√°s abajo si hay par√°metros de descuento/tratamiento
                
                if (clientNameParam) {
                    nameInput.value = decodeURIComponent(clientNameParam.replace(/\+/g, ' '));
                    nameInput.readOnly = true; // Hacer el nombre de solo lectura si viene de la URL
                    document.getElementById('displayDate').textContent = decodeURIComponent(appointmentDateParam.replace(/\+/g, ' '));
                } else {
                    nameInput.value = 'Estimado/a cliente/a';
                    document.getElementById('displayDate').textContent = decodeURIComponent(appointmentDateParam.replace(/\+/g, ' '));
                }
                confirmBtn.style.display = 'block';
                inviteBtn.style.display = 'block';
                inviteBtnDiffusion.style.display = 'none'; // Ocultar el bot√≥n de difusi√≥n en enlaces de recordatorio
                document.getElementById('referralPromoDiffusion').style.display = 'none'; // Ocultar la secci√≥n de difusi√≥n

                // Ajustar la oferta principal para enlaces de recordatorio con descuentos/tratamientos
                const urlDiscount = getUrlParameter('descuento');
                const urlTreatment = getUrlParameter('tratamiento');
                const urlReferrerDiscount = getUrlParameter('descuentoReferente');
                const urlNewClientDiscount = getUrlParameter('descuentoNuevoCliente');

                if (urlDiscount && urlTreatment) {
                    offerTitle.textContent = `¬°${urlDiscount}% OFF en ${urlTreatment}!`;
                    offerDescription.innerHTML = `Como cliente especial, aprovecha un <strong>${urlDiscount}% de descuento</strong> en tu servicio de <strong>${urlTreatment}</strong>. ¬°No te lo pierdas!`;
                    mainOfferCard.style.display = 'block';
                } else if (urlDiscount) {
                    offerTitle.textContent = `¬°${urlDiscount}% DE DESCUENTO EN TU PR√ìXIMO SERVICIO!`;
                    offerDescription.innerHTML = `Como cliente especial, disfruta de un incre√≠ble <strong>${urlDiscount}% de descuento</strong> en tu pr√≥ximo tratamiento. ¬°Tu momento de relajaci√≥n y belleza te espera!`;
                    mainOfferCard.style.display = 'block';
                } else { // Si solo hay tratamiento o ninguno, se muestra la oferta de referidos
                    offerTitle.textContent = '¬°Oferta Especial de Referidos!';
                    const displayReferrerDiscount = urlReferrerDiscount || '10';
                    const displayNewClientDiscount = urlNewClientDiscount || '50';
                    offerDescription.innerHTML = `Confirma tu turno y si invitas a tus amigos en las pr√≥ximas 24 horas, t√∫ obtienes un <strong>${displayReferrerDiscount}% DE DESCUENTO</strong> por cada uno que contrate un servicio, ¬°y ellos un <strong>${displayNewClientDiscount}% DE DESCUENTO</strong> en su primer tratamiento!`;
                    mainOfferCard.style.display = 'block';
                }
            } else if (!urlRouletteDiscount) { // Si no es enlace de recordatorio y tampoco trae un descuento de ruleta predefinido
                // Comportamiento por defecto para promociones generales
                appointmentDisplayGroup.style.display = 'none'; 
                confirmBtn.style.display = 'block'; 
                disclaimerMessage.style.display = 'block'; 

                const urlName = getUrlParameter('nombre');
                if (urlName) {
                    nameInput.value = urlName;
                } else {
                    nameInput.value = "Hola!"; 
                }
                confirmBtn.innerHTML = '<i class="fas fa-phone-alt"></i> CONSULTAR POR UN TURNO';
                disclaimerMessage.innerHTML = '<i class="fas fa-bullhorn"></i> ¬°Bienvenido/a a Le Bardol! Aqu√≠ puedes consultar por nuestros servicios y aprovechar nuestras promociones.';

                const urlDiscount = getUrlParameter('descuento');
                const urlTreatment = getUrlParameter('tratamiento');
                const urlDiffusionReferrerDiscount = getUrlParameter('descuentoReferenteDifusion');
                const urlDiffusionNewClientDiscount = getUrlParameter('descuentoNuevoClienteDifusion');

                if (urlDiscount && urlTreatment) {
                    offerTitle.textContent = `¬°${urlDiscount}% OFF en ${urlTreatment}!`;
                    offerDescription.innerHTML = `Aprovecha esta oportunidad √∫nica y obt√©n un <strong>${urlDiscount}% de descuento</strong> en tu servicio de <strong>${urlTreatment}</strong>. ¬°No te lo pierdas!`;
                    mainOfferCard.style.display = 'block'; 
                    referralPromoDiffusion.style.display = 'block'; 
                    inviteBtnDiffusion.style.display = 'block'; 
                } else if (urlDiscount) {
                    offerTitle.textContent = `¬°${urlDiscount}% DE DESCUENTO EN TODOS LOS SERVICIOS!`;
                    offerDescription.innerHTML = `Disfruta de un incre√≠ble <strong>${urlDiscount}% de descuento</strong> en cualquiera de nuestros tratamientos. ¬°Tu momento de relajaci√≥n y belleza te espera!`;
                    mainOfferCard.style.display = 'block';
                    referralPromoDiffusion.style.display = 'block';
                    inviteBtnDiffusion.style.display = 'block';
                } else if (urlTreatment) {
                    offerTitle.textContent = `¬°Promoci√≥n Especial en ${urlTreatment}!`;
                    offerDescription.innerHTML = `Descubre los beneficios de nuestro servicio de <strong>${urlTreatment}</strong> con una promoci√≥n exclusiva. ¬°Agenda tu cita hoy mismo!`;
                    mainOfferCard.style.display = 'block';
                    referralPromoDiffusion.style.display = 'block';
                    inviteBtnDiffusion.style.display = 'block';
                } else {
                    mainOfferCard.style.display = 'none'; 
                    referralPromoDiffusion.style.display = 'block'; 
                    inviteBtnDiffusion.style.display = 'block';
                }
                inviteBtn.style.display = 'none'; 

                const displayDiffusionReferrerDiscount = urlDiffusionReferrerDiscount || '5';
                const displayDiffusionNewClientDiscount = urlDiffusionNewClientDiscount || '5';
                referralPromoDiffusion.querySelector('p').innerHTML = `Si reservas un turno y nos recomiendas a un amigo, obtendr√°s un <strong>${displayDiffusionReferrerDiscount}% DE DESCUENTO ADICIONAL</strong> en tu pr√≥xima sesi√≥n cuando tu amigo contrate su primer servicio, ¬°y tu amigo obtendr√° un <strong>${displayDiffusionNewClientDiscount}% DE DESCUENTO</strong> en su primer servicio!`;
            }

            // Asignar eventos a los botones (siempre, independientemente de la secci√≥n visible)
            document.getElementById('confirmBtn').addEventListener('click', () => {
                const urlDiscount = getUrlParameter('descuento'); // Re-obtener para el mensaje de WhatsApp
                const urlTreatment = getUrlParameter('tratamiento'); // Re-obtener para el mensaje de WhatsApp
                if (validateForm(isReminderLink)) {
                    sendWhatsAppMessage(isReminderLink, urlDiscount, urlTreatment);
                    showNotification();
                }
            });
            
            document.getElementById('inviteBtn').addEventListener('click', shareInvitation); 
            document.getElementById('inviteBtnDiffusion').addEventListener('click', shareInvitationDiffusion); 

            nameInput.addEventListener('input', toggleInviteButton);
            
            if (isReminderLink) {
                toggleInviteButton(); 
            } else {
                // Si no es un enlace de recordatorio, el bot√≥n de invitar general debe estar habilitado por defecto
                // a menos que el nombre est√© vac√≠o, lo cual se maneja con toggleInviteButton().
                // Aqu√≠ solo aseguramos que no est√© deshabilitado si ya hay un nombre.
                if (nameInput.value.trim() !== '' && nameInput.value.trim() !== 'Hola!') {
                    inviteBtn.disabled = false; 
                }
            }

            startCountdown(); // Iniciar el contador de la oferta principal
            populatePriceList(customPricesFromUrl); // Llenar la lista de precios, pasando los de la URL si existen
            
            // L√≥gica de redimensionamiento del canvas para la ruleta
            if (showRoulette === 'true' || urlRouletteDiscount) { // Tambi√©n redimensionar si hay un descuento de ruleta predefinido
                resizeCanvas(); // Ajustar el tama√±o del canvas al cargar
                window.addEventListener('resize', resizeCanvas); // Ajustar el tama√±o del canvas al redimensionar la ventana
            }
        });
    </script>
</body>
</html>
